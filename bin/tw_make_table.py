#!/usr/bin/env python3
"""Render TW daily watchlist markdown table from tw-data.json.

Input: JSON generated by bin/tw_report_data.py
Output: Markdown table + (optional) 1-line data gap note.

We also add a 'name' column using a small built-in mapping for David's watchlist.
If name unknown, output 'NA'.
"""

from __future__ import annotations

import json
import sys
from pathlib import Path

# Minimal mapping for David's current watchlist
NAME_MAP = {
    # ETFs
    "0050": "元大台灣50",
    "00631L": "元大台灣50正2",
    # Large caps
    "2330": "台積電",
    "2454": "聯發科",
    "2317": "鴻海",
    "2308": "台達電",
    "2344": "華邦電",
    "2327": "國巨",
    "2449": "京元電子",
    "2357": "華碩",
    "3017": "奇鋐",
    "2408": "南亞科",
    "2337": "旺宏",
    # The following codes may be TWSE/TPEX; keep names best-effort
    "8299": "群聯",
    "6669": "緯穎",
}


def fmt(x):
    return "NA" if x is None else str(x)


def main():
    if len(sys.argv) < 2:
        print("Usage: tw_make_table.py /path/to/tw-data.json", file=sys.stderr)
        raise SystemExit(2)

    data = json.loads(Path(sys.argv[1]).read_text(encoding="utf-8"))

    codes = list(data.keys())

    header = [
        "代號",
        "名稱",
        "收盤價",
        "漲跌",
        "漲跌幅",
        "成交量(張)",
        "外資買賣超(張)",
        "投信買賣超(張)",
        "自營商買賣超(張)",
    ]

    print("| " + " | ".join(header) + " |")
    print("|" + "|".join(["---"] * len(header)) + "|")

    gaps = []

    for code in codes:
        r = data[code]
        insti = r.get("insti") or {}
        name = NAME_MAP.get(code, "NA")

        row = [
            code,
            name,
            fmt(r.get("close")),
            fmt(r.get("change")),
            fmt(r.get("pct")),
            fmt(r.get("volume_lots")),
            fmt(insti.get("foreign_lots")),
            fmt(insti.get("it_lots")),
            fmt(insti.get("dealer_lots")),
        ]
        print("| " + " | ".join(row) + " |")

        if r.get("error"):
            gaps.append(f"{code}:{r['error']}")

    if gaps:
        print("\n資料缺口註記：" + "；".join(gaps))


if __name__ == "__main__":
    main()
